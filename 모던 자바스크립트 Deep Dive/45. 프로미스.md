# 45장: 프로미스<sup>Promise</sup>

> "ES6에서... 프로미스를 도입했다. 프로미스는 전통적인 콜백 패턴이 가진 단점을 보완하며 비동기 처리 시점을 명확하게 표현할 수 있다는 장점이 있다" (p.842)

-   [45장: 프로미스Promise](#45장-프로미스promise)
    -   [45-1. 비동기 처리를 위한 콜백 패턴의 단점](#45-1-비동기-처리를-위한-콜백-패턴의-단점)
        -   [45-1-1. 콜백 헬 Callback Hell](#45-1-1-콜백-헬-callback-hell)
        -   [45-1-2. 에러 처리의 한계](#45-1-2-에러-처리의-한계)
    -   [45-2. 프로미스의 생성](#45-2-프로미스의-생성)

---

## 45-1. 비동기 처리를 위한 콜백 패턴의 단점

### 45-1-1. 콜백 헬 <sup>Callback Hell</sup>

```javascript
get("/step1", (a) => {
    get("/step2", (b) => {
        get("/step3", (c) => {
            get("/step4", (d) => {
                console.log(d);
            });
        });
    });
});
```

-   비동기 함수는 비동기 처리 결과를 외부에 반환할 수 업소, 상위 스코프의 변수에 할당할 수도 없다
-   따라서 비동기 함수의 처리 결과(서버의 응답 등)에 대한 후속 처리는 비동기 함수 내부에서 수행해야 한다
-   이때 비동기 함수를 범용적으로 사용하기 위해 비동기 함수에 비동기 처리 결과에 대한 후속 처리를 수행하는 콜백 함수를 전달하는 것이 일반적이다
-   하지만 그렇기 때문에 비동기 함수가 비동기 처리 결과를 가지고 또 다시 비동기 함수를 호출해야 하는 경우가 있으면 **콜백 헬**이 된다
-   콜백 헬은 가독성이 나쁠뿐 아니라 실수/에러가 발생할 확률이 높다

### 45-1-2. 에러 처리의 한계

```javascript
try {
    setTimeout(() => {
        throw new Error("Intentional Error.");
    }, 1000);
} catch (error) {
    console.error("Caught this error: ", e);
}
```

-   '비동기 처리를 위한 콜백 패턴'의 문제점 중에서 가장 심각한 것은 에러 처리가 곤란하다는 점이다
-   에러는 호출자 방향으로 전파된다. 즉, 콜스택의 아래 방향(실행 중인 실행 컨텍스트가 push되기 직전에 push된 실행 컨텍스트 방향)으로 전파된다
-   위 예제에서 setTimeout 함수를 통해 1초 후 고의적인 에러를 발생시켰다
-   하지만 setTimeout 함수의 콜백 함수를 호출한 것은 setTimeout 함수가 아니다, 따라서 setTimeout 함수의 콜백 함수가 발생시킨 에러는 catch 블록에서 캐치되지 않는다

<br>

## 45-2. 프로미스의 생성

```javascript
const promise = new Promise((resolve, reject) => {
  if(/* 비동기 처리 성공 */) resolve('result');
  else rejejct('failure reason');
});
```

-   Promise 생성자 함수를 new 연산자와 함께 호출하면 프로미스 객체를 생성한다 (표준 빌트인)
-   Promise 생성자 함수는 비동기 처리를 수행할 콜백 함수<sup>Executor</sup>를 인수로 받는데, 이 콜백 함수는 resolve와 reject 함수를 인수로 전달받는다
-   비동기 처리가 성공적이면 'resolve'함수, 비동기 처리가 실패하면 'reject' 함수를 호출한다
-   프로미스 객체는 다음과 같이 현재 비동기 처리가 어떻게 진행되고 있는지를 나타내는 상태 정보를 갖는다

| <center>프로미스의 상태 정보</center> | <center>의미</center>                 | <center>상태 변경 조건</center>  |
| ------------------------------------- | ------------------------------------- | -------------------------------- |
| pending                               | 비동기 처리가 아직 수행되지 않은 상태 | 프로미스가 생성된 직후 기본 상태 |
| fulfilled                             | 비동기 처리가 수행된 상태(성공)       | resolve 함수 호출                |
| rejected                              | 비동기 처리가 수행된 상태(실패)       | reject 함수 호출                 |

-   성공<sup>fulfilled</sup>, 실패<sup>rejected</sup> 상태를 합쳐 **settled**라고 표현한다
-   pending 상태에서는 settled 상태로 변화할 수 있지만, 한번 settled 상태가 되면 더 이상 다른 상태로 변화할 수 없다
